# Modal Stack Management - Implementation Plan v2

**AmaÃ§:** Otomatik ve merkezi ESC key handling sistemi - `x-closeable` directive

---

## Konsept

Her modal/overlay tek bir directive ekler, sistem otomatik yÃ¶netir:

```blade
{{-- Eklenmesi gereken tek ÅŸey --}}
<flux:modal x-closeable="() => $wire.set('showModal', false)" ...>

{{-- veya overlay iÃ§in --}}
<div x-closeable="() => $wire.close()" x-show="isOpen" ...>
```

**DavranÄ±ÅŸ:** LIFO (Last In, First Out) - Son aÃ§Ä±lan ilk kapanÄ±r.

---

## BirleÅŸik Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Alpine.store('closeable')               â”‚
â”‚                                                            â”‚
â”‚  stack: [                                                  â”‚
â”‚    { id: 'day-detail', close: fn },                       â”‚
â”‚    { id: 'appointment-form', close: fn },                 â”‚
â”‚    { id: 'calendar-list', close: fn },                    â”‚
â”‚    { id: 'calendar-form', close: fn },  â† ESC bunu kapatÄ±râ”‚
â”‚  ]                                                         â”‚
â”‚                                                            â”‚
â”‚  handleEscape() â†’ stack.pop().close()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation

### Dosya 1: `resources/js/directives/closeable.js`

```javascript
/**
 * x-closeable directive
 * 
 * KullanÄ±m:
 *   x-closeable="() => close()"           - Basit
 *   x-closeable="{ close: fn, id: 'x' }"  - ID ile (opsiyonel)
 * 
 * Otomatik olarak:
 *   - Element gÃ¶rÃ¼nÃ¼r olduÄŸunda stack'e ekler
 *   - Element gizlendiÄŸinde stack'ten Ã§Ä±karÄ±r
 *   - ESC'de en son eklenen kapatÄ±lÄ±r
 */
document.addEventListener('alpine:init', () => {
    // Store
    Alpine.store('closeable', {
        stack: [],
        counter: 0,
        
        register(closeFn, customId = null) {
            const id = customId || `closeable-${++this.counter}`
            this.stack.push({ id, close: closeFn })
            return id
        },
        
        unregister(id) {
            const index = this.stack.findIndex(item => item.id === id)
            if (index !== -1) {
                this.stack.splice(index, 1)
            }
        },
        
        closeTop() {
            if (this.stack.length === 0) return false
            
            const top = this.stack.pop()
            if (top && typeof top.close === 'function') {
                top.close()
                return true
            }
            return false
        },
        
        hasItems() {
            return this.stack.length > 0
        }
    })
    
    // Global ESC listener
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && Alpine.store('closeable').hasItems()) {
            e.preventDefault()
            e.stopPropagation()
            Alpine.store('closeable').closeTop()
        }
    })
    
    // Directive
    Alpine.directive('closeable', (el, { expression }, { evaluate, cleanup }) => {
        let closeableId = null
        let isRegistered = false
        
        // Expression'dan close fonksiyonunu al
        const getCloseFn = () => {
            const value = evaluate(expression)
            if (typeof value === 'function') {
                return value
            } else if (value && typeof value.close === 'function') {
                return value.close
            }
            console.warn('x-closeable: close function not found')
            return null
        }
        
        // Visibility observer
        const observer = new MutationObserver(() => {
            const isVisible = el.offsetParent !== null || 
                              el.style.display !== 'none' ||
                              !el.hasAttribute('x-cloak')
            
            if (isVisible && !isRegistered) {
                const closeFn = getCloseFn()
                if (closeFn) {
                    closeableId = Alpine.store('closeable').register(closeFn)
                    isRegistered = true
                }
            } else if (!isVisible && isRegistered) {
                Alpine.store('closeable').unregister(closeableId)
                isRegistered = false
            }
        })
        
        // x-show deÄŸiÅŸimlerini yakala
        const checkVisibility = () => {
            // Alpine x-show iÃ§in: element DOM'da ve gÃ¶rÃ¼nÃ¼r
            const computedStyle = window.getComputedStyle(el)
            const isVisible = computedStyle.display !== 'none' && 
                              computedStyle.visibility !== 'hidden'
            
            if (isVisible && !isRegistered) {
                const closeFn = getCloseFn()
                if (closeFn) {
                    closeableId = Alpine.store('closeable').register(closeFn)
                    isRegistered = true
                }
            } else if (!isVisible && isRegistered) {
                Alpine.store('closeable').unregister(closeableId)
                isRegistered = false
            }
        }
        
        // MutationObserver ile style deÄŸiÅŸimlerini izle
        observer.observe(el, { 
            attributes: true, 
            attributeFilter: ['style', 'class', 'hidden'] 
        })
        
        // Ä°lk kontrol
        // KÃ¼Ã§Ã¼k gecikme ile x-show'un iÅŸlemesini bekle
        setTimeout(checkVisibility, 50)
        
        // x-show deÄŸiÅŸimlerini yakala (Alpine internal)
        el._x_doShow = new Proxy(el._x_doShow || (() => {}), {
            apply(target, thisArg, args) {
                const result = Reflect.apply(target, thisArg, args)
                setTimeout(checkVisibility, 10)
                return result
            }
        })
        
        el._x_doHide = new Proxy(el._x_doHide || (() => {}), {
            apply(target, thisArg, args) {
                // Kapanmadan Ã–NCE unregister
                if (isRegistered) {
                    Alpine.store('closeable').unregister(closeableId)
                    isRegistered = false
                }
                return Reflect.apply(target, thisArg, args)
            }
        })
        
        // Cleanup
        cleanup(() => {
            observer.disconnect()
            if (isRegistered) {
                Alpine.store('closeable').unregister(closeableId)
            }
        })
    })
})
```

### Dosya 2: `resources/js/app.js` GÃ¼ncelleme

```javascript
// Mevcut import'larÄ±n altÄ±na ekle
import './directives/closeable.js'
```

---

## Modal GÃ¼ncellemeleri

### Day-Detail (Overlay)

```blade
{{-- Ã–NCE --}}
<div x-data="{ show: @entangle('isOpen'), modalOpen: false }" 
     @modal-toggled.window="modalOpen = $event.detail.isOpen"
     @keydown.window.escape="if (!modalOpen) $wire.close()"
     ...>

{{-- SONRA --}}
<div x-data="{ show: @entangle('isOpen') }"
     x-closeable="() => $wire.close()"
     x-show="show"
     ...>
```

### Appointment Form

```blade
{{-- Ã–NCE --}}
<div x-data="{ localOpen: false, init() { ... } }" 
     @keydown.window.escape="if($wire.showModal) $wire.set('showModal', false)">
    <flux:modal wire:model="showModal" ...>

{{-- SONRA --}}
<div>
    <flux:modal wire:model="showModal" 
                x-closeable="() => $wire.set('showModal', false)"
                ...>
```

### Calendar Manager (Her Ä°ki Modal)

```blade
{{-- List Modal --}}
<flux:modal wire:model="showModal" 
            x-closeable="() => $wire.set('showModal', false)"
            ...>

{{-- Form Modal (Nested) --}}
<flux:modal wire:model="showFormModal"
            x-closeable="() => $wire.closeFormModal()"
            ...>
```

### Delete Confirmation

```blade
<flux:modal wire:model="showModal"
            x-closeable="() => $wire.set('showModal', false)"
            ...>
```

---

## Dosya Listesi

| Ä°ÅŸlem | Dosya |
|-------|-------|
| ğŸ†• CREATE | `resources/js/directives/closeable.js` |
| âœï¸ MODIFY | `resources/js/app.js` |
| âœï¸ MODIFY | `calendar/day-detail.blade.php` |
| âœï¸ MODIFY | `calendar/appointment-form.blade.php` |
| âœï¸ MODIFY | `calendar/calendar-manager.blade.php` |
| âœï¸ MODIFY | `calendar/delete-confirmation.blade.php` |

---

## DavranÄ±ÅŸ SenaryolarÄ±

| #  | AÃ§Ä±k Modal'lar (sÄ±rayla) | ESC 1 | ESC 2 | ESC 3 |
|----|--------------------------|-------|-------|-------|
| 1  | day-detail | kapanÄ±r | - | - |
| 2  | day-detail â†’ apt-form | apt-form kapanÄ±r | day-detail kapanÄ±r | - |
| 3  | cal-list â†’ cal-form | cal-form kapanÄ±r | cal-list kapanÄ±r | - |
| 4  | day-detail â†’ cal-list â†’ cal-form | cal-form | cal-list | day-detail |

---

## Verification

```bash
npm run build

# Manuel test:
1. Day-detail aÃ§ â†’ ESC â†’ kapanÄ±r âœ“
2. Day-detail â†’ Appointment form â†’ ESC â†’ form kapanÄ±r, day-detail kalÄ±r âœ“
3. Calendar manager â†’ New Calendar â†’ ESC â†’ form kapanÄ±r, list kalÄ±r âœ“
4. TÃ¼m modal'larÄ± aÃ§ â†’ ESC x4 â†’ sÄ±rayla hepsi kapanÄ±r âœ“
```

---

## Avantajlar

1. âœ… **Tek directive** - `x-closeable` ekle, bitti
2. âœ… **Otomatik stack** - aÃ§Ä±lma sÄ±rasÄ±nÄ± takip eder
3. âœ… **Merkezi ESC** - tek listener, Ã§akÄ±ÅŸma yok
4. âœ… **GeniÅŸletilebilir** - yeni modal/overlay eklendiÄŸinde sadece directive ekle
5. âœ… **Flux uyumlu** - `flux:modal` ile Ã§alÄ±ÅŸÄ±r
6. âœ… **Overlay uyumlu** - normal div'lerle de Ã§alÄ±ÅŸÄ±r
