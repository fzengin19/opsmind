# Faz 2.2: GeliÅŸmiÅŸ Rol ve Ä°zin YÃ¶netimi (Role Builder) â¬œ

**SÃ¼re:** 2 gÃ¼n  
**Ã–nkoÅŸul:** Faz 2.1 (Spatie Teams Refactor) âœ…  
**Ã‡Ä±ktÄ±:** KullanÄ±cÄ±larÄ±n kendi rollerini oluÅŸturup izinlerini yÃ¶netebileceÄŸi arayÃ¼z  
**Durum:** â¬œ BAÅLAMADI

---

## ğŸ¯ AmaÃ§

Faz 2.1 ile Spatie Teams altyapÄ±sÄ±na geÃ§tik ancak ÅŸu an sistem "statik" Ã§alÄ±ÅŸÄ±yor. Roller (`owner`, `admin`, `member`) kod iÃ§inde oluÅŸturuluyor ve kullanÄ±cÄ± bunlarÄ± deÄŸiÅŸtiremiyor.

Bu fazÄ±n amacÄ±, OpsMind'Ä± **gerÃ§ek bir SaaS platformuna** dÃ¶nÃ¼ÅŸtÃ¼rerek, firma sahiplerinin (Owner) ve yÃ¶neticilerin:
1.  Kendi rollerini (Ã¶rn: "SatÄ±ÅŸ Ekibi", "Stajyer", "Proje YÃ¶neticisi") oluÅŸturabilmesini,
2.  Mevcut rollerin izinlerini (Ã¶rn: `member` rolÃ¼ne `task.delete` yetkisi vermek) gÃ¼ncelleyebilmesini saÄŸlamaktÄ±r.

---

## ğŸ— Mimari ve MantÄ±k

### 1. Ä°zin KaynaÄŸÄ± (The Source of Truth)
Sistemdeki yetenekler (capabilities) bellidir ve developer (biz) tarafÄ±ndan `RoleSeeder` iÃ§inde tanÄ±mlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ± yeni **izin** oluÅŸturamaz, var olan izinleri **rollere** atar.

**Ä°zin GruplarÄ± (UI GÃ¶sterimi Ä°Ã§in):**

| Grup | Ä°zinler |
| :--- | :--- |
| **Firma YÃ¶netimi** | `company.manage`, `user.view`, `user.invite`, `user.update` |
| **KiÅŸiler (CRM)** | `contact.view`, `contact.create`, `contact.update`, `contact.delete` |
| **Ajanda** | `appointment.view`, `appointment.create`, `appointment.update`, `appointment.delete` |
| **Ajanda** | `appointment.view`, `appointment.create`, `appointment.update`, `appointment.delete` |
| **GÃ¶revler** | `task.view`, `task.create`, `task.update`, `task.delete`, `task.assign` |
| **Rol YÃ¶netimi** | `role.view`, `role.create`, `role.update`, `role.delete` |

### 2. Rol YÃ¶netim KurallarÄ±
*   **Owner (Sahip):**
    *   Sistem rolÃ¼dÃ¼r.
    *   âŒ Silinemez.
    *   âŒ AdÄ± deÄŸiÅŸtirilemez.
    *   âŒ Ä°zinleri deÄŸiÅŸtirilemez (Her yetkiye sahiptir + Gate Bypass).
    *   ğŸ‘ Sadece listede gÃ¶rÃ¼nÃ¼r.
*   **Admin & Member (VarsayÄ±lan Roller):**
    *   `CreateCompanyAction` ile otomatik oluÅŸurlar.
    *   âœ… Ä°zinleri dÃ¼zenlenebilir.
    *   âœ… AdÄ± deÄŸiÅŸtirilebilir.
    *   âš ï¸ Silinebilir (EÄŸer bu role atanmÄ±ÅŸ aktif kullanÄ±cÄ± yoksa).
*   **Custom Roller (Ã–zel):**
    *   KullanÄ±cÄ± tarafÄ±ndan oluÅŸturulur.
    *   âœ… Tamamen yÃ¶netilebilir.

### 3. GÃ¼venlik (Privilege Escalation Protection)
*   Bir kullanÄ±cÄ±, **kendinde olmayan bir yetkiyi** baÅŸkasÄ±na veremez veya oluÅŸturduÄŸu role ekleyemez.
*   Ancak `Owner` zaten her yetkiye (bypass) sahip olduÄŸu iÃ§in kÄ±sÄ±tlama yoktur.

---

## ğŸ“ YapÄ±lacaklar Listesi

### 2.2.1 Route ve Navigasyon
- [ ] `routes/web.php`: `/settings/roles` rotasÄ±nÄ± ekle (Auth + HasCompany middleware).
- [ ] **Kritik:** Route veya Component iÃ§inde `Gate::authorize('role.view')` kontrolÃ¼ yap.
- [ ] `resources/views/components/layouts/app/sidebar.blade.php`: Linki `can('role.view')` ile sarmala.

### 2.2.2 Backend: Ä°zin Servisi ve Lokalizasyon
- [ ] `lang/tr/permissions.php`: Yeni `role.*` izinlerini de ekle.
- [ ] `RoleSeeder.php`: `role.view`, `role.create`, `role.update`, `role.delete` izinlerini sisteme ekle.

### 2.2.3 UI: Rol Listesi
- [ ] `mount()` metodunda `Gate::authorize('role.view')` Ã§aÄŸÄ±r.

### 2.2.4 UI: Rol DÃ¼zenleme
- [ ] `save()` metodunda `Gate::authorize('role.create')` veya `('role.update')` Ã§aÄŸÄ±r.

### 2.2.6 Entegrasyon: CreateCompanyAction
- [ ] `Admin` rolÃ¼ne varsayÄ±lan olarak `role.*` izinlerini ver (Owner zaten bypass).

---

## ğŸ§ª Test Senaryosu (Manuel)

1.  **GÃ¶rÃ¼ntÃ¼leme:** Ayarlar > Roller sayfasÄ±na git. `Owner`, `Admin`, `Member` rollerini gÃ¶r.
2.  **Yeni Rol:** "EditÃ¶r" adÄ±nda rol aÃ§. `contact.view` ve `task.create` yetkilerini ver. Kaydet.
3.  **Atama:** TakÄ±m sayfasÄ±na git, bir Ã¼yeye "EditÃ¶r" rolÃ¼nÃ¼ ver.
4.  **Kontrol:** O Ã¼ye ile giriÅŸ yap. `contact.delete` yapamÄ±yor mu? `task.create` yapabiliyor mu?
5.  **DÃ¼zenleme:** "EditÃ¶r" rolÃ¼ne `contact.delete` yetkisi ekle. Ãœyenin yetkisi anÄ±nda gÃ¼ncellenmeli.
6.  **Silme:** "EditÃ¶r" rolÃ¼nde biri varken silmeye Ã§alÄ±ÅŸ (Hata vermeli). Ãœyeyi baÅŸka role al, sonra sil (BaÅŸarÄ±lÄ± olmalÄ±).

---

## ğŸ“‚ Dosya YapÄ±sÄ±

```
app/
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ PermissionService.php          # YENÄ° (Ä°zin gruplama mantÄ±ÄŸÄ±)
â”‚
resources/views/livewire/settings/
â””â”€â”€ roles/
    â”œâ”€â”€ index.blade.php                # YENÄ° (Liste)
    â””â”€â”€ form.blade.php                 # YENÄ° (Ekle/DÃ¼zenle Modal)

tests/Feature/Settings/
â””â”€â”€ RoleTest.php                       # YENÄ°
```
