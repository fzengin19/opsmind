# Faz 5.6: Calendar CRUD

**SÃ¼re:** 1-2 gÃ¼n  
**Ã–nkoÅŸul:** Faz 4.5 (Calendar Entity) âœ…, Faz 5 (Appointment CRUD) âœ…  
**Ã‡Ä±ktÄ±:** Takvim oluÅŸturma, dÃ¼zenleme, silme modal'Ä±

---

## AmaÃ§

KullanÄ±cÄ±larÄ±n kendi takvimlerini yÃ¶netmelerini saÄŸlayan modal tabanlÄ± CRUD sistemi. Mevcut `calendar/index.blade.php` ÅŸiÅŸirilmeden, ayrÄ± bir `calendar-manager.blade.php` Volt component'i olarak eklenecek.

---

## Mevcut Durum

### âœ… HazÄ±r Olanlar

| BileÅŸen | Dosya | Durum |
|---------|-------|-------|
| Calendar Model | `app/Models/Calendar.php` | âœ… TÃ¼m alanlar ve iliÅŸkiler |
| Enum'lar | `CalendarType`, `CalendarVisibility` | âœ… HazÄ±r |
| Company iliÅŸkisi | `calendars()`, `defaultCalendar()` | âœ… HazÄ±r |
| Otomatik oluÅŸturma | `CompanyObserver` (ÅŸirket), `Company::addUser()` (kiÅŸisel) | âœ… Ã‡alÄ±ÅŸÄ±yor |
| Pivot tablo | `calendar_user` (role: owner/editor/viewer) | âœ… HazÄ±r |
| EriÅŸim scope | `Calendar::accessibleBy($user)` | âœ… HazÄ±r |
| Factory | `CalendarFactory.php` (default, personal states) | âœ… HazÄ±r |
| Testler | `tests/Feature/Models/CalendarTest.php` | âœ… Model testleri var |
| Dil dosyalarÄ± | `lang/*/enums.php`, `lang/*/calendar.php` | âœ… KÄ±smi |

### âŒ Eksikler

- [ ] `CalendarPolicy` - EriÅŸim kontrolÃ¼ yok
- [ ] Action Classes - Create/Update/Delete yok
- [ ] `CalendarData` DTO - Validasyon iÃ§in
- [ ] `calendar-manager.blade.php` - CRUD modal component yok
- [ ] Dil anahtarlarÄ± - Manager iÃ§in Ã§eviriler eksik
- [ ] CRUD Testleri - Action/Policy testleri yok

---

## Ä°ÅŸ KurallarÄ±

### Takvim Tipleri ve KÄ±sÄ±tlamalar

| Tip | OluÅŸturulma | DÃ¼zenlenebilir Alanlar | Silinebilir |
|-----|-------------|------------------------|-------------|
| `Default` | Otomatik (CompanyObserver) | Sadece `name`, `color` | âŒ Asla |
| `Personal` | Otomatik (addUser) | Sadece `name`, `color` | âŒ Sadece removeUser ile |
| `Team` | Manuel (admin/owner) | `name`, `color`, `visibility` | âœ… |
| `Resource` | Manuel (admin/owner) | `name`, `color`, `visibility` | âœ… |

### Silme DavranÄ±ÅŸÄ±

Bir takvim silindiÄŸinde:
1. Takvime ait randevular **varsayÄ±lan takvime taÅŸÄ±nÄ±r** (veri kaybÄ± yok)
2. `calendar_user` pivot kayÄ±tlarÄ± **cascade ile silinir**
3. `is_default=true` olan takvim **asla silinemez**

### Policy Matrisi

| Aksiyon | owner | admin | manager | member |
|---------|-------|-------|---------|--------|
| TÃ¼m takvimleri listele | âœ… | âœ… | âœ… | âœ… |
| Takvimlere eriÅŸim | Visibility'ye gÃ¶re | Visibility'ye gÃ¶re | Visibility'ye gÃ¶re | Visibility'ye gÃ¶re |
| Team/Resource takvim oluÅŸtur | âœ… | âœ… | âŒ | âŒ |
| Kendi oluÅŸturduÄŸu takvimi dÃ¼zenle | âœ… | âœ… | âœ… | âœ… |
| BaÅŸkasÄ±nÄ±n takvimini dÃ¼zenle | âœ… | âœ… | âŒ | âŒ |
| Takvim sil | âœ… | âœ… | âŒ | âŒ |

> **Not:** `Gate::before` ile `owner` rolÃ¼ tÃ¼m policy kontrollerini bypass eder.

---

## Form AlanlarÄ±

| Alan | Tip | Validasyon | Notlar |
|------|-----|------------|--------|
| `name` | text | required, max:100 | |
| `color` | color picker | required, regex:`#[0-9A-Fa-f]{6}` | Preset + custom |
| `type` | select | required, in:team,resource | Sadece create'de, sonra readonly |
| `visibility` | select | required, enum | Team/Resource iÃ§in |

---

## GÃ¶revler

### 5.6.1 CalendarData DTO

**Dosya:** `app/Data/CalendarData.php`

```php
<?php

declare(strict_types=1);

namespace App\Data;

use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use Livewire\Wireable;
use Spatie\LaravelData\Attributes\Validation\Max;
use Spatie\LaravelData\Attributes\Validation\Regex;
use Spatie\LaravelData\Concerns\WireableData;
use Spatie\LaravelData\Data;

class CalendarData extends Data implements Wireable
{
    use WireableData;

    public function __construct(
        public readonly ?int $id,

        #[Max(100)]
        public readonly string $name,

        #[Regex('/^#[0-9A-Fa-f]{6}$/')]
        public readonly string $color,

        public readonly CalendarType $type,

        public readonly CalendarVisibility $visibility,
    ) {}
}
```

---

### 5.6.2 CalendarPolicy

**Dosya:** `app/Policies/CalendarPolicy.php`

```php
<?php

declare(strict_types=1);

namespace App\Policies;

use App\Enums\CalendarType;
use App\Models\Calendar;
use App\Models\User;

class CalendarPolicy
{
    /**
     * Åirket Ã§alÄ±ÅŸanlarÄ± takvim listesini gÃ¶rebilir.
     */
    public function viewAny(User $user): bool
    {
        return $user->currentCompany() !== null;
    }

    /**
     * Calendar::isAccessibleBy() ile belirlenir.
     */
    public function view(User $user, Calendar $calendar): bool
    {
        if ($calendar->company_id !== $user->currentCompany()?->id) {
            return false;
        }

        return $calendar->isAccessibleBy($user);
    }

    /**
     * Sadece owner/admin yeni Team/Resource takvim oluÅŸturabilir.
     */
    public function create(User $user): bool
    {
        return $user->currentCompany() !== null
            && $user->hasAnyRole(['owner', 'admin']);
    }

    /**
     * Takvim dÃ¼zenleme kurallarÄ±:
     * - Default/Personal: Sadece name ve color dÃ¼zenlenebilir
     * - Team/Resource: OluÅŸturan veya admin/owner dÃ¼zenleyebilir
     */
    public function update(User $user, Calendar $calendar): bool
    {
        if ($calendar->company_id !== $user->currentCompany()?->id) {
            return false;
        }

        // Personal takvim sadece owner tarafÄ±ndan dÃ¼zenlenebilir
        if ($calendar->type === CalendarType::Personal) {
            return $calendar->users()
                ->where('user_id', $user->id)
                ->where('role', 'owner')
                ->exists();
        }

        // Default takvim ÅŸirket admin/owner'Ä± tarafÄ±ndan dÃ¼zenlenebilir
        if ($calendar->is_default) {
            return $user->hasAnyRole(['owner', 'admin']);
        }

        // Team/Resource: OluÅŸturan (pivot owner) veya admin/owner
        $isCalendarOwner = $calendar->users()
            ->where('user_id', $user->id)
            ->where('role', 'owner')
            ->exists();

        return $isCalendarOwner || $user->hasAnyRole(['owner', 'admin']);
    }

    /**
     * Silme kurallarÄ±:
     * - Default takvim silinemez
     * - Personal takvim silinemez (sadece removeUser ile)
     * - Team/Resource: Admin/owner silebilir
     */
    public function delete(User $user, Calendar $calendar): bool
    {
        if ($calendar->company_id !== $user->currentCompany()?->id) {
            return false;
        }

        // Default ve Personal takvimler silinemez
        if ($calendar->is_default || $calendar->type === CalendarType::Personal) {
            return false;
        }

        // Sadece admin/owner silebilir
        return $user->hasAnyRole(['owner', 'admin']);
    }
}
```

> **Not:** Laravel 12'de `app/Policies` iÃ§indeki Policy'ler otomatik kayÄ±t olur.

---

### 5.6.3 Action Classes

**Yeni klasÃ¶r:** `app/Actions/Calendars/`

#### CreateCalendarAction.php

```php
<?php

declare(strict_types=1);

namespace App\Actions\Calendars;

use App\Data\CalendarData;
use App\Models\Calendar;
use App\Models\User;
use Illuminate\Support\Facades\DB;

class CreateCalendarAction
{
    public function execute(CalendarData $data, User $user): Calendar
    {
        return DB::transaction(function () use ($data, $user) {
            $calendar = Calendar::create([
                'company_id' => $user->currentCompany()->id,
                'name' => $data->name,
                'color' => $data->color,
                'type' => $data->type,
                'visibility' => $data->visibility,
                'is_default' => false,
            ]);

            // OluÅŸturan kiÅŸiyi owner olarak pivot'a ekle
            $calendar->users()->attach($user->id, ['role' => 'owner']);

            return $calendar;
        });
    }
}
```

#### UpdateCalendarAction.php

```php
<?php

declare(strict_types=1);

namespace App\Actions\Calendars;

use App\Data\CalendarData;
use App\Enums\CalendarType;
use App\Models\Calendar;

class UpdateCalendarAction
{
    public function execute(Calendar $calendar, CalendarData $data): Calendar
    {
        $updateData = [
            'name' => $data->name,
            'color' => $data->color,
        ];

        // Visibility sadece Team/Resource iÃ§in gÃ¼ncellenebilir
        if (in_array($calendar->type, [CalendarType::Team, CalendarType::Resource])) {
            $updateData['visibility'] = $data->visibility;
        }

        // type ve is_default ASLA gÃ¼ncellenmez

        $calendar->update($updateData);

        return $calendar->fresh();
    }
}
```

#### DeleteCalendarAction.php

```php
<?php

declare(strict_types=1);

namespace App\Actions\Calendars;

use App\Enums\CalendarType;
use App\Models\Calendar;
use DomainException;
use Illuminate\Support\Facades\DB;

class DeleteCalendarAction
{
    public function execute(Calendar $calendar): void
    {
        // GÃ¼venlik kontrolÃ¼
        if ($calendar->is_default) {
            throw new DomainException(__('calendar.cannot_delete_default'));
        }

        if ($calendar->type === CalendarType::Personal) {
            throw new DomainException(__('calendar.cannot_delete_personal'));
        }

        DB::transaction(function () use ($calendar) {
            // RandevularÄ± varsayÄ±lan takvime taÅŸÄ±
            $defaultCalendar = $calendar->company->defaultCalendar();

            if ($defaultCalendar) {
                $calendar->appointments()->update([
                    'calendar_id' => $defaultCalendar->id,
                ]);
            }

            // calendar_user pivot'larÄ± cascade ile silinir (FK constraint)
            $calendar->delete();
        });
    }
}
```

---

### 5.6.4 Calendar Manager Component

**Dosya:** `resources/views/livewire/calendar/calendar-manager.blade.php`

```php
<?php

use Livewire\Volt\Component;
use Livewire\Attributes\Computed;
use Livewire\Attributes\On;
use App\Actions\Calendars\CreateCalendarAction;
use App\Actions\Calendars\UpdateCalendarAction;
use App\Actions\Calendars\DeleteCalendarAction;
use App\Data\CalendarData;
use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use App\Models\Calendar;
use Illuminate\Foundation\Auth\Access\AuthorizesRequests;
use Illuminate\Support\Collection;

new class extends Component {
    use AuthorizesRequests;

    public bool $showModal = false;
    public bool $showForm = false;
    public ?Calendar $editingCalendar = null;

    // Form fields
    public string $name = '';
    public string $color = '#3b82f6';
    public string $type = 'team';
    public string $visibility = 'company_wide';

    // Preset colors
    public array $presetColors = [
        '#ef4444', // Red
        '#f97316', // Orange
        '#eab308', // Yellow
        '#22c55e', // Green
        '#14b8a6', // Teal
        '#3b82f6', // Blue
        '#8b5cf6', // Violet
        '#ec4899', // Pink
        '#6b7280', // Gray
    ];

    protected function rules(): array
    {
        return [
            'name' => 'required|string|max:100',
            'color' => ['required', 'regex:/^#[0-9A-Fa-f]{6}$/'],
            'type' => 'required|in:team,resource',
            'visibility' => 'required|in:company_wide,members_only,private',
        ];
    }

    #[On('open-calendar-manager')]
    public function open(): void
    {
        $this->resetForm();
        $this->showModal = true;
        $this->showForm = false;
    }

    public function startCreate(): void
    {
        $this->authorize('create', Calendar::class);
        $this->resetForm();
        $this->showForm = true;
    }

    public function startEdit(int $calendarId): void
    {
        $this->editingCalendar = Calendar::findOrFail($calendarId);
        $this->authorize('update', $this->editingCalendar);

        $this->fill([
            'name' => $this->editingCalendar->name,
            'color' => $this->editingCalendar->color,
            'type' => $this->editingCalendar->type->value,
            'visibility' => $this->editingCalendar->visibility->value,
        ]);

        $this->showForm = true;
    }

    public function save(
        CreateCalendarAction $createAction,
        UpdateCalendarAction $updateAction
    ): void {
        $this->validate();

        $data = new CalendarData(
            id: $this->editingCalendar?->id,
            name: $this->name,
            color: $this->color,
            type: CalendarType::from($this->type),
            visibility: CalendarVisibility::from($this->visibility),
        );

        if ($this->editingCalendar) {
            $updateAction->execute($this->editingCalendar, $data);
            session()->flash('calendar-message', __('calendar.calendar_updated'));
        } else {
            $createAction->execute($data, auth()->user());
            session()->flash('calendar-message', __('calendar.calendar_created'));
        }

        $this->resetForm();
        $this->showForm = false;
        $this->dispatch('calendar-refresh');
    }

    public function confirmDelete(int $calendarId): void
    {
        $calendar = Calendar::findOrFail($calendarId);
        $this->authorize('delete', $calendar);

        $this->dispatch('confirm-delete-calendar', calendarId: $calendarId);
    }

    public function delete(int $calendarId, DeleteCalendarAction $action): void
    {
        $calendar = Calendar::findOrFail($calendarId);
        $this->authorize('delete', $calendar);

        try {
            $action->execute($calendar);
            session()->flash('calendar-message', __('calendar.calendar_deleted'));
            $this->dispatch('calendar-refresh');
        } catch (\DomainException $e) {
            session()->flash('calendar-error', $e->getMessage());
        }
    }

    public function resetForm(): void
    {
        $this->reset(['editingCalendar', 'name', 'type', 'visibility']);
        $this->color = '#3b82f6';
        $this->type = 'team';
        $this->visibility = 'company_wide';
        $this->resetValidation();
    }

    public function cancelForm(): void
    {
        $this->resetForm();
        $this->showForm = false;
    }

    #[Computed]
    public function calendars(): Collection
    {
        $user = auth()->user();
        if (!$user || !$user->currentCompany()) {
            return collect();
        }

        return Calendar::where('company_id', $user->currentCompany()->id)
            ->orderByDesc('is_default')
            ->orderBy('type')
            ->orderBy('name')
            ->get();
    }

    #[Computed]
    public function canCreate(): bool
    {
        return auth()->user()?->can('create', Calendar::class) ?? false;
    }
}; ?>

<div>
    <flux:modal wire:model="showModal" class="max-w-2xl">
        <div class="p-6">
            {{-- Header --}}
            <div class="flex items-center justify-between mb-6">
                <flux:heading size="lg">{{ __('calendar.manage_calendars') }}</flux:heading>

                @if($this->canCreate && !$showForm)
                    <flux:button variant="primary" size="sm" icon="plus" wire:click="startCreate">
                        {{ __('calendar.new_calendar') }}
                    </flux:button>
                @endif
            </div>

            {{-- Flash Messages --}}
            @if(session()->has('calendar-message'))
                <flux:callout variant="success" class="mb-4">
                    {{ session('calendar-message') }}
                </flux:callout>
            @endif

            @if(session()->has('calendar-error'))
                <flux:callout variant="danger" class="mb-4">
                    {{ session('calendar-error') }}
                </flux:callout>
            @endif

            {{-- Create/Edit Form --}}
            @if($showForm)
                <div class="p-4 mb-6 border rounded-lg border-zinc-200 dark:border-zinc-700 bg-zinc-50 dark:bg-zinc-800/50">
                    <flux:heading size="sm" class="mb-4">
                        {{ $editingCalendar ? __('calendar.edit_calendar') : __('calendar.new_calendar') }}
                    </flux:heading>

                    <form wire:submit="save" class="space-y-4">
                        {{-- Name --}}
                        <flux:input
                            wire:model.blur="name"
                            label="{{ __('calendar.calendar_name') }}"
                            placeholder="{{ __('calendar.calendar_name_placeholder') }}"
                            required
                        />

                        {{-- Color Picker --}}
                        <div>
                            <label class="block text-sm font-medium mb-2">{{ __('calendar.calendar_color') }}</label>

                            {{-- Preset Colors --}}
                            <div class="flex flex-wrap gap-2 mb-3">
                                @foreach($presetColors as $preset)
                                    <button
                                        type="button"
                                        wire:click="$set('color', '{{ $preset }}')"
                                        class="size-8 rounded-full border-2 transition-transform hover:scale-110 {{ $color === $preset ? 'border-zinc-900 dark:border-white ring-2 ring-offset-2 ring-primary-500' : 'border-transparent' }}"
                                        style="background-color: {{ $preset }}"
                                    ></button>
                                @endforeach
                            </div>

                            {{-- Custom Color Input --}}
                            <div class="flex items-center gap-3">
                                <input
                                    type="color"
                                    wire:model.live="color"
                                    class="size-10 rounded cursor-pointer border border-zinc-300 dark:border-zinc-600"
                                />
                                <flux:input
                                    type="text"
                                    wire:model.blur="color"
                                    class="w-28 font-mono"
                                    placeholder="#3b82f6"
                                />
                            </div>
                            <flux:error name="color" />
                        </div>

                        {{-- Type (only for create) --}}
                        @if(!$editingCalendar)
                            <flux:select wire:model="type" label="{{ __('calendar.calendar_type') }}" required>
                                <option value="team">{{ __('enums.calendar_type.team') }}</option>
                                <option value="resource">{{ __('enums.calendar_type.resource') }}</option>
                            </flux:select>
                        @endif

                        {{-- Visibility (only for Team/Resource) --}}
                        @if(!$editingCalendar || in_array($editingCalendar?->type->value, ['team', 'resource']))
                            <flux:select wire:model="visibility" label="{{ __('calendar.calendar_visibility') }}" required>
                                @foreach(App\Enums\CalendarVisibility::cases() as $v)
                                    <option value="{{ $v->value }}">{{ $v->label() }}</option>
                                @endforeach
                            </flux:select>
                        @endif

                        {{-- Actions --}}
                        <div class="flex justify-end gap-2 pt-2">
                            <flux:button variant="ghost" type="button" wire:click="cancelForm">
                                {{ __('common.cancel') }}
                            </flux:button>
                            <flux:button variant="primary" type="submit">
                                {{ $editingCalendar ? __('common.update') : __('common.create') }}
                            </flux:button>
                        </div>
                    </form>
                </div>
            @endif

            {{-- Calendar List --}}
            <div class="space-y-2">
                @forelse($this->calendars as $calendar)
                    <div
                        wire:key="calendar-{{ $calendar->id }}"
                        class="flex items-center justify-between p-3 rounded-lg border border-zinc-200 dark:border-zinc-700 hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition"
                    >
                        <div class="flex items-center gap-3">
                            {{-- Color Dot --}}
                            <span
                                class="size-4 rounded-full flex-shrink-0"
                                style="background-color: {{ $calendar->color }}"
                            ></span>

                            {{-- Name & Badges --}}
                            <div>
                                <div class="font-medium text-zinc-900 dark:text-zinc-100">
                                    {{ $calendar->name }}
                                </div>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <flux:badge size="sm" variant="outline">
                                        {{ $calendar->type->label() }}
                                    </flux:badge>
                                    @if($calendar->is_default)
                                        <flux:badge size="sm" color="primary">
                                            {{ __('calendar.default') }}
                                        </flux:badge>
                                    @endif
                                    @if($calendar->visibility !== App\Enums\CalendarVisibility::CompanyWide)
                                        <flux:badge size="sm" variant="outline" color="zinc">
                                            {{ $calendar->visibility->label() }}
                                        </flux:badge>
                                    @endif
                                </div>
                            </div>
                        </div>

                        {{-- Actions --}}
                        <div class="flex items-center gap-1">
                            @can('update', $calendar)
                                <flux:button
                                    variant="ghost"
                                    size="sm"
                                    icon="pencil"
                                    wire:click="startEdit({{ $calendar->id }})"
                                />
                            @endcan

                            @can('delete', $calendar)
                                <flux:button
                                    variant="ghost"
                                    size="sm"
                                    icon="trash"
                                    class="text-red-500 hover:text-red-600"
                                    wire:click="delete({{ $calendar->id }})"
                                    wire:confirm="{{ __('calendar.calendar_delete_confirm', ['name' => $calendar->name]) }}"
                                />
                            @endcan
                        </div>
                    </div>
                @empty
                    <div class="text-center py-8 text-zinc-500">
                        <flux:icon name="calendar" class="size-12 mx-auto mb-2 opacity-50" />
                        <p>{{ __('calendar.no_calendars') }}</p>
                    </div>
                @endforelse
            </div>

            {{-- Close Button --}}
            <div class="flex justify-end mt-6">
                <flux:button variant="ghost" wire:click="$set('showModal', false)">
                    {{ __('common.close') }}
                </flux:button>
            </div>
        </div>
    </flux:modal>
</div>
```

---

### 5.6.5 Index.blade.php Entegrasyonu

**Dosya:** `resources/views/livewire/calendar/index.blade.php`

#### DeÄŸiÅŸiklik 1: Toolbar'a YÃ¶netim Butonu

SatÄ±r ~186 civarÄ±, filtreleme dropdown'undan Ã¶nce:

```blade
{{-- Takvimleri YÃ¶net Butonu --}}
<flux:button
    variant="ghost"
    size="sm"
    icon="cog-6-tooth"
    wire:click="$dispatch('open-calendar-manager')"
>
    <span class="sr-only">{{ __('calendar.manage_calendars') }}</span>
</flux:button>
```

#### DeÄŸiÅŸiklik 2: Component Include

SatÄ±r ~541 civarÄ±, mevcut modal'lardan sonra:

```blade
{{-- Calendar Manager Modal --}}
<livewire:calendar.calendar-manager />
```

---

### 5.6.6 Language Files

#### `lang/tr/calendar.php` Eklemeler

```php
// Mevcut anahtarlarÄ±n ALTINA ekle:

// Calendar Manager
'manage_calendars' => 'Takvimleri YÃ¶net',
'new_calendar' => 'Yeni Takvim',
'edit_calendar' => 'Takvimi DÃ¼zenle',
'calendar_name' => 'Takvim AdÄ±',
'calendar_name_placeholder' => 'Ã–rn: SatÄ±ÅŸ Ekibi',
'calendar_color' => 'Renk',
'calendar_type' => 'TÃ¼r',
'calendar_visibility' => 'GÃ¶rÃ¼nÃ¼rlÃ¼k',
'default' => 'VarsayÄ±lan',
'no_calendars' => 'HenÃ¼z takvim bulunmuyor.',
'calendar_created' => 'Takvim oluÅŸturuldu.',
'calendar_updated' => 'Takvim gÃ¼ncellendi.',
'calendar_deleted' => 'Takvim silindi.',
'calendar_delete_confirm' => '":name" takvimi silinecek. Randevular varsayÄ±lan takvime taÅŸÄ±nacak. Emin misiniz?',
'cannot_delete_default' => 'VarsayÄ±lan takvim silinemez.',
'cannot_delete_personal' => 'KiÅŸisel takvim silinemez.',
```

#### `lang/en/calendar.php` Eklemeler

```php
// Calendar Manager
'manage_calendars' => 'Manage Calendars',
'new_calendar' => 'New Calendar',
'edit_calendar' => 'Edit Calendar',
'calendar_name' => 'Calendar Name',
'calendar_name_placeholder' => 'e.g. Sales Team',
'calendar_color' => 'Color',
'calendar_type' => 'Type',
'calendar_visibility' => 'Visibility',
'default' => 'Default',
'no_calendars' => 'No calendars yet.',
'calendar_created' => 'Calendar created.',
'calendar_updated' => 'Calendar updated.',
'calendar_deleted' => 'Calendar deleted.',
'calendar_delete_confirm' => 'Calendar ":name" will be deleted. Appointments will be moved to default calendar. Are you sure?',
'cannot_delete_default' => 'Default calendar cannot be deleted.',
'cannot_delete_personal' => 'Personal calendar cannot be deleted.',
```

---

### 5.6.7 Tests

#### `tests/Feature/Policies/CalendarPolicyTest.php`

```php
<?php

declare(strict_types=1);

use App\Enums\CalendarType;
use App\Models\Calendar;
use App\Models\Company;
use App\Models\User;

beforeEach(function () {
    $this->seed(\Database\Seeders\RoleSeeder::class);
});

describe('CalendarPolicy', function () {
    it('allows any company user to view calendars', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'member');

        $this->actingAs($user);
        setPermissionsTeamId($company->id);

        expect($user->can('viewAny', Calendar::class))->toBeTrue();
    });

    it('allows owner to create calendar', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'owner');

        $this->actingAs($user);
        setPermissionsTeamId($company->id);

        expect($user->can('create', Calendar::class))->toBeTrue();
    });

    it('denies member from creating calendar', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'member');

        $this->actingAs($user);
        setPermissionsTeamId($company->id);

        expect($user->can('create', Calendar::class))->toBeFalse();
    });

    it('allows calendar owner to update their calendar', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'member');

        $calendar = Calendar::factory()->create([
            'company_id' => $company->id,
            'type' => CalendarType::Team,
        ]);
        $calendar->users()->attach($user->id, ['role' => 'owner']);

        $this->actingAs($user);
        setPermissionsTeamId($company->id);

        expect($user->can('update', $calendar))->toBeTrue();
    });

    it('prevents deletion of default calendar', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'owner');

        $defaultCalendar = $company->defaultCalendar();

        $this->actingAs($user);
        setPermissionsTeamId($company->id);

        expect($user->can('delete', $defaultCalendar))->toBeFalse();
    });

    it('prevents deletion of personal calendar', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'owner');

        $personalCalendar = $company->calendars()
            ->where('type', CalendarType::Personal)
            ->first();

        $this->actingAs($user);
        setPermissionsTeamId($company->id);

        expect($user->can('delete', $personalCalendar))->toBeFalse();
    });

    it('allows deletion of team calendar by admin', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $admin = User::factory()->create();
        $company->addUser($admin, 'admin');

        $calendar = Calendar::factory()->create([
            'company_id' => $company->id,
            'type' => CalendarType::Team,
        ]);

        $this->actingAs($admin);
        setPermissionsTeamId($company->id);

        expect($admin->can('delete', $calendar))->toBeTrue();
    });
});
```

#### `tests/Feature/Actions/CalendarActionsTest.php`

```php
<?php

declare(strict_types=1);

use App\Actions\Calendars\CreateCalendarAction;
use App\Actions\Calendars\DeleteCalendarAction;
use App\Actions\Calendars\UpdateCalendarAction;
use App\Data\CalendarData;
use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use App\Models\Appointment;
use App\Models\Calendar;
use App\Models\Company;
use App\Models\User;

beforeEach(function () {
    $this->seed(\Database\Seeders\RoleSeeder::class);
});

describe('CreateCalendarAction', function () {
    it('creates calendar and attaches user as owner', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'owner');

        $this->actingAs($user);

        $data = new CalendarData(
            id: null,
            name: 'Sales Team',
            color: '#ef4444',
            type: CalendarType::Team,
            visibility: CalendarVisibility::CompanyWide,
        );

        $action = new CreateCalendarAction();
        $calendar = $action->execute($data, $user);

        expect($calendar)
            ->name->toBe('Sales Team')
            ->color->toBe('#ef4444')
            ->type->toBe(CalendarType::Team)
            ->is_default->toBeFalse();

        expect($calendar->users()->where('role', 'owner')->first()->id)->toBe($user->id);
    });
});

describe('UpdateCalendarAction', function () {
    it('updates name and color', function () {
        $calendar = Calendar::factory()->create([
            'name' => 'Old Name',
            'color' => '#000000',
            'type' => CalendarType::Team,
        ]);

        $data = new CalendarData(
            id: $calendar->id,
            name: 'New Name',
            color: '#ffffff',
            type: CalendarType::Team,
            visibility: CalendarVisibility::CompanyWide,
        );

        $action = new UpdateCalendarAction();
        $updated = $action->execute($calendar, $data);

        expect($updated)
            ->name->toBe('New Name')
            ->color->toBe('#ffffff');
    });

    it('does not change type', function () {
        $calendar = Calendar::factory()->create(['type' => CalendarType::Team]);

        $data = new CalendarData(
            id: $calendar->id,
            name: 'Test',
            color: '#ffffff',
            type: CalendarType::Resource, // FarklÄ± tip
            visibility: CalendarVisibility::CompanyWide,
        );

        $action = new UpdateCalendarAction();
        $updated = $action->execute($calendar, $data);

        expect($updated->type)->toBe(CalendarType::Team); // DeÄŸiÅŸmemeli
    });
});

describe('DeleteCalendarAction', function () {
    it('moves appointments to default calendar', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'owner');

        $teamCalendar = Calendar::factory()->create([
            'company_id' => $company->id,
            'type' => CalendarType::Team,
        ]);

        $appointment = Appointment::factory()->create([
            'company_id' => $company->id,
            'calendar_id' => $teamCalendar->id,
            'created_by' => $user->id,
        ]);

        $action = new DeleteCalendarAction();
        $action->execute($teamCalendar);

        expect(Calendar::find($teamCalendar->id))->toBeNull();
        expect($appointment->fresh()->calendar_id)->toBe($company->defaultCalendar()->id);
    });

    it('throws exception for default calendar', function () {
        $company = Company::factory()->create();
        $defaultCalendar = $company->defaultCalendar();

        $action = new DeleteCalendarAction();

        expect(fn () => $action->execute($defaultCalendar))
            ->toThrow(\DomainException::class);
    });
});
```

---

## Dosya Listesi

| Ä°ÅŸlem | Dosya |
|-------|-------|
| ğŸ†• CREATE | `app/Policies/CalendarPolicy.php` |
| ğŸ†• CREATE | `app/Data/CalendarData.php` |
| ğŸ†• CREATE | `app/Actions/Calendars/CreateCalendarAction.php` |
| ğŸ†• CREATE | `app/Actions/Calendars/UpdateCalendarAction.php` |
| ğŸ†• CREATE | `app/Actions/Calendars/DeleteCalendarAction.php` |
| ğŸ†• CREATE | `resources/views/livewire/calendar/calendar-manager.blade.php` |
| ğŸ†• CREATE | `tests/Feature/Policies/CalendarPolicyTest.php` |
| ğŸ†• CREATE | `tests/Feature/Actions/CalendarActionsTest.php` |
| âœï¸ MODIFY | `resources/views/livewire/calendar/index.blade.php` (+2 satÄ±r) |
| âœï¸ MODIFY | `lang/tr/calendar.php` (+14 anahtar) |
| âœï¸ MODIFY | `lang/en/calendar.php` (+14 anahtar) |

---

## DoÄŸrulama

### Otomatik Testler

```bash
# TÃ¼m takvim testlerini Ã§alÄ±ÅŸtÄ±r
php artisan test --filter=Calendar

# Sadece yeni testler
php artisan test tests/Feature/Policies/CalendarPolicyTest.php
php artisan test tests/Feature/Actions/CalendarActionsTest.php

# Pint ile formatting
vendor/bin/pint --dirty
```

### Manuel Test AdÄ±mlarÄ±

1. [ ] **Takvim sayfasÄ±nÄ± aÃ§** â†’ Toolbar'da gear ikonu gÃ¶rÃ¼nmeli
2. [ ] **Gear ikonuna tÄ±kla** â†’ "Takvimleri YÃ¶net" modal aÃ§Ä±lmalÄ±
3. [ ] **Takvim listesi** â†’ Mevcut takvimler listede gÃ¶rÃ¼nmeli (Genel + KiÅŸisel)
4. [ ] **Owner olarak**: "Yeni Takvim" butonu gÃ¶rÃ¼nmeli
5. [ ] **Member olarak**: "Yeni Takvim" butonu gÃ¶rÃ¼nmemeli
6. [ ] **Yeni takvim oluÅŸtur** â†’ Form doldur, renk seÃ§, kaydet â†’ Listede gÃ¶rÃ¼nmeli
7. [ ] **Takvim gÃ¶rÃ¼nÃ¼mÃ¼nde** â†’ Yeni takvim filtrede gÃ¶rÃ¼nmeli
8. [ ] **Takvim dÃ¼zenle** â†’ Ä°sim/renk deÄŸiÅŸtir â†’ Etkinlik renklerinde yansÄ±malÄ±
9. [ ] **Team takvim sil** â†’ Onay ver â†’ Silinmeli, randevular varsayÄ±lana taÅŸÄ±nmalÄ±
10. [ ] **Default takvimi silmeye Ã§alÄ±ÅŸ** â†’ Sil butonu gÃ¶rÃ¼nmemeli (policy)
11. [ ] **Personal takvimi silmeye Ã§alÄ±ÅŸ** â†’ Sil butonu gÃ¶rÃ¼nmemeli (policy)
12. [ ] **Visibility deÄŸiÅŸtir** â†’ MembersOnly yapÄ±nca diÄŸer kullanÄ±cÄ±lar gÃ¶rememeli

---

## Sonraki AdÄ±mlar (Post-MVP)

- [ ] Takvime kullanÄ±cÄ± ekleme/Ã§Ä±karma (editor/viewer rolleri)
- [ ] Takvim paylaÅŸÄ±m linki
- [ ] Takvim renk ÅŸemasÄ± (gradient, pattern)
- [ ] Takvim arÅŸivleme (silmeden gizleme)
- [ ] Takvim iÃ§e/dÄ±ÅŸa aktarma (iCal)
