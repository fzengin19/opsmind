# Faz 2.3: Navigation & Tenant Context Refactor (Revize Edilmiş)

**Süre:** 1 gün  
**Durum:** Hazırlık Aşamasında (Audit Sonrası Revize)  
**Önkoşul:** Faz 2.2 ve Codebase Audit

---

## Tespit Edilen Riskler ve Düzeltmeler

Yapılan derinlemesine kod incelemesinde (Audit) şu noktalar tespit edildi:

1.  **`AppServiceProvider` İçindeki Yan Etki:**
    - Mevcut kodda `Gate::before` içinde `setPermissionsTeamId` çağrılıyor. Bu, her yetki kontrolünde tekrar tekrar çalışıyor ve potansiyel performans/tutarsızlık sorunu yaratıyor.
    - **Düzeltme:** Bu işlem `InitializeTenancy` middleware'ine taşınacak ve servis sağlayıcıdan kaldırılacak.

2.  **Middleware Güvenliği:**
    - Rol yönetimi rotaları için `EnsureHasCompany` middleware'ini kaldırmak riskli. Eğer kullanıcı URL'yi manuel girerse ve firması yoksa, yetki kontrolü başarısız olsa bile kod hata verebilir.
    - **Karar:** `EnsureHasCompany` (Redirect) middleware'i, firma gerektiren (Team, Roles) rotalarda **KALACAK**.

---

## Mimari Değişiklikler

### 1. Middleware Stratejisi

| Middleware | Amaç | Davranış | Rotalar |
|------------|------|----------|---------|
| `InitializeTenancy` (Global) | Bağlamı Yükle | Varsa `setPermissionsTeamId` yapar, yoksa pas geçer. Asla redirect etmez. | `web` grubu (Tüm sayfalar) |
| `EnsureHasCompany` (Route) | Firmayı Zorla | Firma yoksa Onboarding'e atar. | `dashboard`, `team`, `settings/roles` |

### 2. NavigationService

Blade dosyalarındaki karmaşayı önlemek için menü mantığı servise taşınacak.

---

## Görevler

### 2.3.1 Backend Refactoring

- [ ] `app/Http/Middleware/InitializeTenancy.php` oluştur:
  ```php
  // Global olarak web grubuna eklenecek
  public function handle(Request $request, Closure $next): Response
  {
      if (auth()->check() && ($company = auth()->user()->currentCompany())) {
          setPermissionsTeamId($company->id);
      }
      return $next($request);
  }
  ```

- [ ] `app/Providers/AppServiceProvider.php` temizle:
  - `Gate::before` içindeki `setPermissionsTeamId` satırını **SİL**. Sadece Owner kontrolü kalsın.

- [ ] `app/Http/Middleware/EnsureHasCompany.php` sadeleştir:
  - İçindeki `setPermissionsTeamId` satırını **SİL** (Artık InitializeTenancy yapıyor).
  - Sadece redirect (`!hasCompany`) kalsın.

- [ ] `bootstrap/app.php` güncelle:
  - `InitializeTenancy` middleware'ini `web` grubuna ekle.

### 2.3.2 NavigationService Implementasyonu

- [ ] `app/Services/NavigationService.php` oluştur:
  - `getSidebarMenu()` metodu ile array döndür.
  - Firma Adı, Apps (Dashboard, Team, Roles), User Menu yapılarını kur.

### 2.3.3 Frontend Entegrasyonu

- [ ] `app/Providers/AppServiceProvider.php`:
  - `View::composer('components.layouts.app.sidebar', ...)` ekle.

- [ ] `resources/views/components/layouts/app/sidebar.blade.php`:
  - Hardcoded flux menülerini sil.
  - Servisten gelen array ile döngü kur.
  - **Tasarım:** 
    - En üstte Firma Adı (Dropdown placeholder).
    - Ortada Ana Linkler (Apps).
    - En altta User Profili.

---

## Doğrulama Planı

1.  **Context Testi:**
    - Profile sayfasına (`/settings/profile`) git.
    - `php artisan tinker` ile `setPermissionsTeamId`'nin set edilip edilmediğini kontrol edemeyiz ama Sidebar'da "Roller" linkinin (admin isen) görünüp görünmediğine bak. (Önceki hatanın çözümü).

2.  **Redirect Testi:**
    - Yeni bir kullanıcı aç (firmasız).
    - `/dashboard`'a girmeyi dene -> Onboarding'e atmalı.
    - `/settings/profile`'a girmeyi dene -> Girmeli (Sidebar'da firma menüsü boş/gizli olmalı).

3.  **Owner Yetki Testi:**
    - `AppServiceProvider` değişikliğinden sonra Owner'ın hala her şeyi yapabildiğini doğrula.

---

## Dosya Listesi

```
app/
├── Http/Middleware/
│   ├── InitializeTenancy.php      # [NEW] Global Context
│   └── EnsureHasCompany.php       # [MOD] Only Redirect
├── Services/
│   └── NavigationService.php      # [NEW] Menu Logic
├── Providers/
│   └── AppServiceProvider.php     # [MOD] Clean Gate::before, View Composer

resources/views/components/layouts/app/
└── sidebar.blade.php              # [MOD] Dynamic Menu
```
