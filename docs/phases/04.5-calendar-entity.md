# Faz 4.5: Calendar Entity

**SÃ¼re:** 1-2 gÃ¼n  
**Ã–nkoÅŸul:** Faz 4 (Calendar UI)  
**Ã‡Ä±ktÄ±:** Ã‡oklu takvim desteÄŸi iÃ§in altyapÄ±

---

## AmaÃ§

Åirket iÃ§inde birden fazla takvim (varsayÄ±lan, ekip, kaynak, kiÅŸisel) oluÅŸturabilme altyapÄ±sÄ±nÄ± kurmak. Bu yapÄ±:
- Faz 5'te randevularÄ±n doÄŸru takvime yazÄ±lmasÄ±nÄ± saÄŸlar
- Faz 6'da Google Calendar'Ä±n kiÅŸisel takvime sync edilmesini mÃ¼mkÃ¼n kÄ±lar
- Ä°leride ekip takvimleri, toplantÄ± odasÄ± takvimleri gibi esneklikleri sunar

---

## Veri Modeli

```
Company (1)
    â””â”€â”€ Calendar (N)
            â”œâ”€â”€ name: "Genel Takvim" / "SatÄ±ÅŸ Ekibi" / "ToplantÄ± OdasÄ± A"
            â”œâ”€â”€ color: "#3b82f6"
            â”œâ”€â”€ type: 'default' | 'team' | 'resource' | 'personal'
            â”œâ”€â”€ visibility: 'company_wide' | 'members_only' | 'private'
            â”œâ”€â”€ is_default: boolean
            â””â”€â”€ Appointment (N)

CalendarUser (pivot)
    â”œâ”€â”€ calendar_id
    â”œâ”€â”€ user_id
    â””â”€â”€ role: 'owner' | 'editor' | 'viewer'
```

---

## Otomatik Takvim OluÅŸturma

| Trigger | Takvim | Tip | Visibility |
|---------|--------|-----|------------|
| Åirket oluÅŸturulunca | "Genel Takvim" | `default` | `company_wide` |
| User ÅŸirkete eklenince | "{User.name} Takvimi" | `personal` | `private` |

> **Laravel 12 Pattern:** Observer'lar `#[ObservedBy]` attribute ile model Ã¼zerinde tanÄ±mlanÄ±r.

---

## GÃ¶revler

### 4.5.1 Calendars Migration

```bash
php artisan make:migration create_calendars_table
```

```php
Schema::create('calendars', function (Blueprint $table) {
    $table->id();
    $table->foreignId('company_id')->constrained()->cascadeOnDelete();
    $table->string('name', 100);
    $table->string('color', 7)->default('#3b82f6');
    $table->string('type', 20)->default('default');
    $table->string('visibility', 20)->default('company_wide');
    $table->boolean('is_default')->default(false);
    $table->string('google_calendar_id')->nullable()->unique();
    $table->json('settings')->nullable();
    $table->timestamps();

    $table->index(['company_id', 'type']);
});
```

### 4.5.2 CalendarUser Pivot Migration

```bash
php artisan make:migration create_calendar_user_table
```

```php
Schema::create('calendar_user', function (Blueprint $table) {
    $table->foreignId('calendar_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('role', 20)->default('viewer');
    $table->timestamps();

    $table->primary(['calendar_id', 'user_id']);
});
```

### 4.5.3 Appointments Table Update

```bash
php artisan make:migration add_calendar_id_to_appointments_table
```

```php
Schema::table('appointments', function (Blueprint $table) {
    $table->foreignId('calendar_id')->nullable()->after('company_id')
        ->constrained()->nullOnDelete();
});
```

---

### 4.5.4 Enums

#### `app/Enums/CalendarType.php`

```php
<?php

declare(strict_types=1);

namespace App\Enums;

enum CalendarType: string
{
    case Default = 'default';
    case Team = 'team';
    case Resource = 'resource';
    case Personal = 'personal';

    public function label(): string
    {
        return match ($this) {
            self::Default => __('enums.calendar_type.default'),
            self::Team => __('enums.calendar_type.team'),
            self::Resource => __('enums.calendar_type.resource'),
            self::Personal => __('enums.calendar_type.personal'),
        };
    }
}
```

#### `app/Enums/CalendarVisibility.php`

```php
<?php

declare(strict_types=1);

namespace App\Enums;

enum CalendarVisibility: string
{
    case CompanyWide = 'company_wide';
    case MembersOnly = 'members_only';
    case Private = 'private';

    public function label(): string
    {
        return match ($this) {
            self::CompanyWide => __('enums.calendar_visibility.company_wide'),
            self::MembersOnly => __('enums.calendar_visibility.members_only'),
            self::Private => __('enums.calendar_visibility.private'),
        };
    }
}
```

---

### 4.5.5 Calendar Model

```bash
php artisan make:model Calendar -f
```

```php
<?php

declare(strict_types=1);

namespace App\Models;

use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;

class Calendar extends Model
{
    use HasFactory;

    protected $fillable = [
        'company_id',
        'name',
        'color',
        'type',
        'visibility',
        'is_default',
        'google_calendar_id',
        'settings',
    ];

    protected function casts(): array
    {
        return [
            'type' => CalendarType::class,
            'visibility' => CalendarVisibility::class,
            'is_default' => 'boolean',
            'settings' => 'array',
        ];
    }

    // ==========================================
    // Relationships
    // ==========================================

    public function company(): BelongsTo
    {
        return $this->belongsTo(Company::class);
    }

    public function appointments(): HasMany
    {
        return $this->hasMany(Appointment::class);
    }

    public function users(): BelongsToMany
    {
        return $this->belongsToMany(User::class)
            ->withPivot('role')
            ->withTimestamps();
    }

    // ==========================================
    // Scopes
    // ==========================================

    public function scopeForCompany(Builder $query, int $companyId): Builder
    {
        return $query->where('company_id', $companyId);
    }

    public function scopeAccessibleBy(Builder $query, User $user): Builder
    {
        $companyId = $user->currentCompany()?->id;

        return $query->where(function ($q) use ($companyId) {
            $q->where('visibility', CalendarVisibility::CompanyWide)
                ->where('company_id', $companyId);
        })->orWhereHas('users', fn ($uq) => $uq->where('user_id', $user->id));
    }

    // ==========================================
    // Helpers
    // ==========================================

    public function isAccessibleBy(User $user): bool
    {
        if ($this->visibility === CalendarVisibility::CompanyWide 
            && $this->company_id === $user->currentCompany()?->id) {
            return true;
        }

        return $this->users()->where('user_id', $user->id)->exists();
    }
}
```

---

### 4.5.6 Model Updates

#### `app/Models/Appointment.php`

```php
// $fillable'a ekle:
'calendar_id',

// Yeni relation ekle:
public function calendar(): BelongsTo
{
    return $this->belongsTo(Calendar::class);
}
```

#### `app/Models/Company.php`

```php
<?php
// Dosya baÅŸÄ±na ekle:
use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use App\Observers\CompanyObserver;
use Illuminate\Database\Eloquent\Attributes\ObservedBy;

#[ObservedBy([CompanyObserver::class])]
class Company extends Model
{
    // Yeni relation ekle:
    public function calendars(): HasMany
    {
        return $this->hasMany(Calendar::class);
    }

    public function defaultCalendar(): ?Calendar
    {
        return $this->calendars()->where('is_default', true)->first();
    }

    // addUser() metodunu gÃ¼ncelle:
    public function addUser(User $user, string $roleName, ?int $departmentId = null, ?string $jobTitle = null): void
    {
        $this->users()->attach($user->id, [
            'department_id' => $departmentId,
            'job_title' => $jobTitle,
            'joined_at' => now(),
        ]);

        setPermissionsTeamId($this->id);
        $user->assignRole($roleName);

        // KullanÄ±cÄ±ya kiÅŸisel takvim oluÅŸtur
        $calendar = $this->calendars()->create([
            'name' => $user->name . ' ' . __('calendar.personal_calendar_suffix'),
            'type' => CalendarType::Personal->value,
            'visibility' => CalendarVisibility::Private->value,
            'is_default' => false,
            'color' => '#8b5cf6',
        ]);

        $calendar->users()->attach($user->id, ['role' => 'owner']);
    }
}
```

#### `app/Models/User.php`

```php
// Yeni relation ekle:
public function calendars(): BelongsToMany
{
    return $this->belongsToMany(Calendar::class)
        ->withPivot('role')
        ->withTimestamps();
}
```

---

### 4.5.7 Company Observer

```bash
php artisan make:observer CompanyObserver --model=Company
```

```php
<?php

declare(strict_types=1);

namespace App\Observers;

use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use App\Models\Company;

class CompanyObserver
{
    public function created(Company $company): void
    {
        $company->calendars()->create([
            'name' => __('calendar.default_calendar_name'),
            'type' => CalendarType::Default->value,
            'visibility' => CalendarVisibility::CompanyWide->value,
            'is_default' => true,
            'color' => '#3b82f6',
        ]);
    }
}
```

> **Not:** Laravel 12'de `#[ObservedBy]` attribute kullanÄ±ldÄ±ÄŸÄ±nda `AppServiceProvider`'da kayÄ±t gerekmez.

---

### 4.5.8 CalendarService Update

```php
// Metod imzalarÄ±nÄ± gÃ¼ncelle:
public function getAppointmentsForWeek(Carbon $date, int $companyId, ?int $calendarId = null): Collection
{
    $query = Appointment::where('company_id', $companyId);

    if ($calendarId !== null) {
        $query->where('calendar_id', $calendarId);
    }

    // ... geri kalan kod aynÄ±
}

public function getAppointmentsForMonth(Carbon $date, int $companyId, ?int $calendarId = null): array
{
    $query = Appointment::where('company_id', $companyId);

    if ($calendarId !== null) {
        $query->where('calendar_id', $calendarId);
    }

    // ... geri kalan kod aynÄ±
}
```

---

### 4.5.9 Factory Updates

#### `database/factories/CalendarFactory.php`

```php
<?php

declare(strict_types=1);

namespace Database\Factories;

use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use App\Models\Calendar;
use App\Models\Company;
use Illuminate\Database\Eloquent\Factories\Factory;

/**
 * @extends Factory<Calendar>
 */
class CalendarFactory extends Factory
{
    protected $model = Calendar::class;

    public function definition(): array
    {
        return [
            'company_id' => Company::factory(),
            'name' => fake()->randomElement([
                'Genel Takvim',
                'SatÄ±ÅŸ Ekibi',
                'Pazarlama',
                'ToplantÄ± OdasÄ± A',
            ]),
            'color' => fake()->hexColor(),
            'type' => CalendarType::Default,
            'visibility' => CalendarVisibility::CompanyWide,
            'is_default' => false,
        ];
    }

    public function default(): static
    {
        return $this->state(fn () => [
            'is_default' => true,
            'type' => CalendarType::Default,
        ]);
    }

    public function personal(): static
    {
        return $this->state(fn () => [
            'type' => CalendarType::Personal,
            'visibility' => CalendarVisibility::Private,
        ]);
    }
}
```

#### `database/factories/AppointmentFactory.php`

```php
// definition() iÃ§ine ekle:
'calendar_id' => null,
```

---

### 4.5.10 Migration Seeder

```php
<?php

declare(strict_types=1);

namespace Database\Seeders;

use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use App\Models\Appointment;
use App\Models\Company;
use Illuminate\Database\Seeder;

class CalendarMigrationSeeder extends Seeder
{
    public function run(): void
    {
        $companies = Company::whereDoesntHave('calendars')->get();

        foreach ($companies as $company) {
            $calendar = $company->calendars()->create([
                'name' => __('calendar.default_calendar_name'),
                'type' => CalendarType::Default->value,
                'visibility' => CalendarVisibility::CompanyWide->value,
                'is_default' => true,
                'color' => '#3b82f6',
            ]);

            // Mevcut randevularÄ± bu takvime baÄŸla
            Appointment::where('company_id', $company->id)
                ->whereNull('calendar_id')
                ->update(['calendar_id' => $calendar->id]);

            $this->command->info("âœ… {$company->name} iÃ§in takvim oluÅŸturuldu.");
        }
    }
}
```

---

### 4.5.11 Language Files

#### `lang/tr/enums.php`

```php
// Ekle:
'calendar_type' => [
    'default' => 'Genel',
    'team' => 'Ekip',
    'resource' => 'Kaynak',
    'personal' => 'KiÅŸisel',
],
'calendar_visibility' => [
    'company_wide' => 'Åirket Geneli',
    'members_only' => 'Sadece Ãœyeler',
    'private' => 'Ã–zel',
],
```

#### `lang/en/enums.php`

```php
// Ekle:
'calendar_type' => [
    'default' => 'Default',
    'team' => 'Team',
    'resource' => 'Resource',
    'personal' => 'Personal',
],
'calendar_visibility' => [
    'company_wide' => 'Company Wide',
    'members_only' => 'Members Only',
    'private' => 'Private',
],
```

#### `lang/tr/calendar.php`

```php
// Ekle:
'default_calendar_name' => 'Genel Takvim',
'personal_calendar_suffix' => 'Takvimi',
```

#### `lang/en/calendar.php`

```php
// Ekle:
'default_calendar_name' => 'Default Calendar',
'personal_calendar_suffix' => 'Calendar',
```

---

### 4.5.12 Tests

#### `tests/Feature/Models/CalendarTest.php`

```php
<?php

declare(strict_types=1);

use App\Enums\CalendarType;
use App\Enums\CalendarVisibility;
use App\Models\Appointment;
use App\Models\Calendar;
use App\Models\Company;
use App\Models\User;

describe('Calendar Model', function () {
    beforeEach(function () {
        $this->seed(\Database\Seeders\RoleSeeder::class);
    });

    it('can be created with factory', function () {
        $calendar = Calendar::factory()->create();

        expect($calendar)
            ->toBeInstanceOf(Calendar::class)
            ->id->toBeInt()
            ->name->toBeString();
    });

    it('casts type to CalendarType enum', function () {
        $calendar = Calendar::factory()->create(['type' => 'personal']);

        expect($calendar->type)->toBe(CalendarType::Personal);
    });

    it('casts visibility to CalendarVisibility enum', function () {
        $calendar = Calendar::factory()->create(['visibility' => 'private']);

        expect($calendar->visibility)->toBe(CalendarVisibility::Private);
    });

    it('belongs to company', function () {
        $company = Company::factory()->create();
        $calendar = Calendar::factory()->create(['company_id' => $company->id]);

        expect($calendar->company->id)->toBe($company->id);
    });

    it('has many appointments', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();
        $company->addUser($user, 'owner');
        
        $calendar = $company->defaultCalendar();
        
        Appointment::factory()->create([
            'company_id' => $company->id,
            'calendar_id' => $calendar->id,
            'created_by' => $user->id,
        ]);

        expect($calendar->fresh()->appointments)->toHaveCount(1);
    });

    it('has users through pivot with role', function () {
        $calendar = Calendar::factory()->create();
        $user = User::factory()->create();

        $calendar->users()->attach($user->id, ['role' => 'editor']);

        expect($calendar->users)->toHaveCount(1);
        expect($calendar->users->first()->pivot->role)->toBe('editor');
    });
});

describe('Company Calendar Integration', function () {
    beforeEach(function () {
        $this->seed(\Database\Seeders\RoleSeeder::class);
    });

    it('creates default calendar on company creation', function () {
        $company = Company::factory()->create();

        expect($company->calendars)->toHaveCount(1);
        expect($company->defaultCalendar())
            ->not->toBeNull()
            ->is_default->toBeTrue()
            ->type->toBe(CalendarType::Default);
    });

    it('creates personal calendar when user is added', function () {
        $company = Company::factory()->create();
        createDefaultRolesForCompany($company);
        $user = User::factory()->create();

        $company->addUser($user, 'member');

        // 1 default + 1 personal
        expect($company->fresh()->calendars)->toHaveCount(2);
        
        $personalCalendar = $company->calendars()
            ->where('type', CalendarType::Personal->value)
            ->first();
        
        expect($personalCalendar)
            ->not->toBeNull()
            ->visibility->toBe(CalendarVisibility::Private);
        
        expect($personalCalendar->users->first()->id)->toBe($user->id);
    });
});
```

#### Update `tests/Feature/Models/AppointmentTest.php`

```php
it('belongs to calendar', function () {
    $company = Company::factory()->create();
    createDefaultRolesForCompany($company);
    $user = User::factory()->create();
    $company->addUser($user, 'owner');

    $appointment = Appointment::factory()->create([
        'company_id' => $company->id,
        'calendar_id' => $company->defaultCalendar()->id,
        'created_by' => $user->id,
    ]);

    expect($appointment->calendar)->not->toBeNull();
    expect($appointment->calendar->id)->toBe($company->defaultCalendar()->id);
});
```

---

## Visibility MantÄ±ÄŸÄ±

| Visibility | Kimler GÃ¶rÃ¼r? | Kimler DÃ¼zenler? |
|------------|---------------|------------------|
| `company_wide` | Åirketteki herkes | calendar_user pivot'taki roller |
| `members_only` | Sadece calendar_user'daki kiÅŸiler | Sadece editor/owner |
| `private` | Sadece owner | Sadece owner |

---

## Dosya Listesi

| Ä°ÅŸlem | Dosya |
|-------|-------|
| ğŸ†• CREATE | `database/migrations/xxxx_create_calendars_table.php` |
| ğŸ†• CREATE | `database/migrations/xxxx_create_calendar_user_table.php` |
| ğŸ†• CREATE | `database/migrations/xxxx_add_calendar_id_to_appointments_table.php` |
| ğŸ†• CREATE | `app/Enums/CalendarType.php` |
| ğŸ†• CREATE | `app/Enums/CalendarVisibility.php` |
| ğŸ†• CREATE | `app/Models/Calendar.php` |
| ğŸ†• CREATE | `app/Observers/CompanyObserver.php` |
| ğŸ†• CREATE | `database/factories/CalendarFactory.php` |
| ğŸ†• CREATE | `database/seeders/CalendarMigrationSeeder.php` |
| ğŸ†• CREATE | `tests/Feature/Models/CalendarTest.php` |
| âœï¸ MODIFY | `app/Models/Appointment.php` (+`calendar_id`, +`calendar()`) |
| âœï¸ MODIFY | `app/Models/Company.php` (+`#[ObservedBy]`, +`calendars()`, +`defaultCalendar()`, update `addUser()`) |
| âœï¸ MODIFY | `app/Models/User.php` (+`calendars()`) |
| âœï¸ MODIFY | `app/Services/CalendarService.php` (+`$calendarId` parameter) |
| âœï¸ MODIFY | `database/factories/AppointmentFactory.php` (+`calendar_id => null`) |
| âœï¸ MODIFY | `database/seeders/CalendarDemoSeeder.php` (use default calendar) |
| âœï¸ MODIFY | `lang/tr/enums.php` (+calendar enums) |
| âœï¸ MODIFY | `lang/en/enums.php` (+calendar enums) |
| âœï¸ MODIFY | `lang/tr/calendar.php` (+keys) |
| âœï¸ MODIFY | `lang/en/calendar.php` (+keys) |
| âœï¸ MODIFY | `tests/Feature/Models/CompanyTest.php` (+calendar tests) |
| âœï¸ MODIFY | `tests/Feature/Models/AppointmentTest.php` (+calendar relation test) |

---

## DoÄŸrulama

```bash
# Migrations
php artisan migrate

# Seeder
php artisan db:seed --class=CalendarMigrationSeeder

# Tests
php artisan test --filter=Calendar
php artisan test --filter=Company
php artisan test --filter=Appointment

# Code formatting
vendor/bin/pint --dirty
```

**Manuel test:**
1. Åirkete giriÅŸ yap â†’ VarsayÄ±lan "Genel Takvim" var mÄ±?
2. Yeni kullanÄ±cÄ± ekle â†’ KiÅŸisel takvim oluÅŸtu mu?
3. Mevcut randevular default takvimde gÃ¶rÃ¼nÃ¼yor mu?
4. Takvim sayfasÄ± hala Ã§alÄ±ÅŸÄ±yor mu?

---

## Notlar

- Bu faz sadece **altyapÄ±** oluÅŸturur, UI deÄŸiÅŸikliÄŸi minimal
- Takvim seÃ§ici UI â†’ Faz 5 veya sonrasÄ±
- Google Calendar sync â†’ Faz 6'da `google_calendar_id` kullanÄ±lacak
- Ã‡oklu takvim overlay gÃ¶rÃ¼nÃ¼mÃ¼ â†’ Post-MVP
