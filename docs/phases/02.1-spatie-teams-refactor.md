# Faz 2.1: Spatie Teams Refactor ⬜

**Süre:** 2 gün  
**Önkoşul:** Faz 2 (Auth & Roles) ✅  
**Çıktı:** Firma bazlı dinamik rol sistemi, Spatie teams entegrasyonu  
**Durum:** ✅ TAMAMLANDI

---

## Amaç

Mevcut çift rol sistemini (CompanyRole enum + Spatie global) birleştirip, Spatie Permission'ın `teams` özelliği ile firma bazlı dinamik roller oluşturmak.

---

## Mevcut Sorun

```
MEVCUT (Çift Sistem):
├── company_user.role (string: 'owner', 'admin', 'member')  ← CompanyRole enum
└── model_has_roles (Spatie global roller)                   ← 'admin', 'manager', 'member'

HEDEF (Tek Sistem - Tamamen Spatie):
└── model_has_roles + company_id (Spatie teams)
    ├── 'Sahip' rolü → Tüm yetkiler + Gate bypass
    ├── 'Yönetici' rolü → Tüm yetkiler
    └── 'Üye' rolü → Temel yetkiler
```

> **NOT:** `is_owner` flag'e gerek YOK! "Sahip" de bir Spatie rolü olacak.  
> Fark: Sahip rolü silinemez, değiştirilemez (is_system=true mantığı).

---

## Görevler

### 2.1.1 Config Güncelleme

- [ ] `config/permission.php` düzenle:
  ```php
  'teams' => true,
  'team_foreign_key' => 'company_id',
  ```

### 2.1.2 Migration: Spatie Tablolarına company_id Ekle

- [ ] `database/migrations/xxxx_add_teams_to_permission_tables.php`
  - `roles.company_id` nullable unsignedBigInteger
  - `model_has_roles.company_id` nullable unsignedBigInteger  
  - `model_has_permissions.company_id` nullable unsignedBigInteger
  - İlgili indexler

### 2.1.3 Migration: company_user.role Kolonu Kaldır

- [ ] `database/migrations/xxxx_remove_role_from_company_user.php`
  - `role` kolonunu kaldır
  - **Önemli:** Data migration ÖNCE çalışmalı!

### 2.1.4 Migration: invitations Tablosu Güncelle

- [ ] `invitations.role` → `invitations.role_name` olarak rename
  - Mevcut değerler: 'admin', 'member' → 'Yönetici', 'Üye'

### 2.1.5 Model Değişiklikleri

#### User.php
- [ ] `CompanyRole` import kaldır
- [ ] `roleIn()` → `roleInCompany()` olarak refactor (Spatie Role döndür)
- [ ] `isOwnerOf()` → Spatie 'Sahip' rolü kontrolü

```php
public function isOwnerOf(Company $company): bool
{
    setPermissionsTeamId($company->id);
    return $this->hasRole('Sahip');
}

public function roleInCompany(Company $company): ?\Spatie\Permission\Models\Role
{
    setPermissionsTeamId($company->id);
    return $this->roles()->first();
}
```

#### Company.php
- [ ] `CompanyRole` import kaldır
- [ ] `addUser()` signature değiştir: `(User $user, string $roleName)`
- [ ] `owners()` → Spatie 'Sahip' rolü bazlı
- [ ] `admins()` kaldır

```php
public function addUser(User $user, string $roleName, ?int $departmentId = null, ?string $jobTitle = null): void
{
    $this->users()->attach($user->id, [
        'department_id' => $departmentId,
        'job_title' => $jobTitle,
        'joined_at' => now(),
    ]);

    setPermissionsTeamId($this->id);
    $user->assignRole($roleName);
}

public function owners()
{
    setPermissionsTeamId($this->id);
    return $this->users()->whereHas('roles', fn($q) => $q->where('name', 'Sahip'));
}
```

#### Invitation.php
- [ ] `CompanyRole` import kaldır
- [ ] `getCompanyRole()` → `getRoleName()` olarak değiştir

### 2.1.6 Enum Kaldırma

- [ ] `app/Enums/CompanyRole.php` **SİL**

### 2.1.7 Action Değişiklikleri

#### CreateCompanyAction.php
- [ ] Varsayılan rolleri oluştur (helper method çağır)
- [ ] Sahip rolü ile ekle

```php
public function execute(User $user, string $name): Company
{
    $company = Company::create([...]);

    // Varsayılan rolleri oluştur (Sahip, Yönetici, Üye)
    $this->createDefaultRoles($company);

    // Sahip rolü ile ekle
    $company->addUser($user, 'Sahip');

    return $company;
}

private function createDefaultRoles(Company $company): void
{
    setPermissionsTeamId($company->id);

    // Sahip - Tüm yetkiler, silinemez
    $sahip = Role::create([
        'name' => 'Sahip',
        'guard_name' => 'web',
        'company_id' => $company->id,
    ]);
    $sahip->givePermissionTo(Permission::all());

    // Yönetici - Tüm yetkiler
    $yonetici = Role::create([
        'name' => 'Yönetici',
        'guard_name' => 'web',
        'company_id' => $company->id,
    ]);
    $yonetici->givePermissionTo(Permission::all());

    // Üye - Temel yetkiler
    $uye = Role::create([
        'name' => 'Üye',
        'guard_name' => 'web',
        'company_id' => $company->id,
    ]);
    $uye->givePermissionTo([
        'contact.view', 'contact.create',
        'appointment.view', 'appointment.create',
        'task.view', 'task.create', 'task.update',
    ]);
}
```

#### SendInvitationAction.php
- [ ] `$data->role->value` → `$data->roleName`

#### AcceptInvitationAction.php
- [ ] `getCompanyRole()` → `getRoleName()`
- [ ] Global `assignRole('member')` kaldır

### 2.1.8 Data/DTO Değişiklikleri

#### InvitationData.php
- [ ] `CompanyRole $role` → `string $roleName`

### 2.1.9 Seeder Güncellemesi

#### RoleSeeder.php
- [ ] Global roller oluşturmayı kaldır (firma bazlı olacak)
- [ ] Permissions global kalacak (değişiklik yok)
- [ ] `createDefaultRolesForCompany()` static method ekle

### 2.1.10 View Değişiklikleri

#### team/index.blade.php
- [ ] `CompanyRole` import kaldır
- [ ] `canManageTeam()` → permission bazlı kontrol
- [ ] `updateRole()` → Spatie `syncRoles()` kullan
- [ ] Blade'de rol gösterimi Spatie'den al

```php
public function canManageTeam(): bool
{
    $user = Auth::user();
    setPermissionsTeamId($this->company->id);

    // Sahip her şeyi yapabilir
    if ($user->hasRole('Sahip')) return true;

    return $user->hasPermissionTo('user.invite');
}

public function updateRole(int $userId, string $roleName): void
{
    if (!$this->canManageTeam()) return;

    // Sahip rolü başkasına atanamaz
    if ($roleName === 'Sahip') return;

    $targetUser = User::find($userId);
    setPermissionsTeamId($this->company->id);
    $targetUser->syncRoles([$roleName]);
}
```

### 2.1.11 Owner Bypass (Gate::before)

- [ ] `AppServiceProvider.php` güncelle:

```php
public function boot(): void
{
    Gate::before(function ($user, $ability) {
        $company = $user->currentCompany();
        if ($company) {
            setPermissionsTeamId($company->id);
            if ($user->hasRole('Sahip')) {
                return true;
            }
        }
    });
}
```

### 2.1.12 Notification Değişiklikleri

#### InviteUserNotification.php
- [ ] `getCompanyRole()->label()` → `getRoleName()` olarak değiştir

### 2.1.13 Factory Değişiklikleri

#### UserFactory.php
- [ ] `CompanyRole` import kaldır
- [ ] `forCompany()` method signature: `(Company $company, string $roleName = 'Üye')`
- [ ] `asOwner()` → `forCompany($company, 'Sahip')`
- [ ] `asAdmin()` → `forCompany($company, 'Yönetici')`
- [ ] `asManager()` → KALDIR (artık yok)

### 2.1.14 Seeder Değişiklikleri

#### DatabaseSeeder.php
- [ ] `CompanyRole` import kaldır
- [ ] `addUser()` çağrılarını string rol adına çevir
- [ ] Firma için varsayılan rolleri oluştur

### 2.1.15 Lang Dosyaları

- [ ] `lang/tr/team.php` - Rol etiketleri artık DB'den gelecek, sadece UI metinleri
- [ ] `lang/en/team.php` - Aynı

### 2.1.16 Test Güncellemeleri

- [ ] `tests/Feature/Models/CompanyTest.php` - `addUser()` signature
- [ ] `tests/Feature/Models/UserTest.php` - `roleIn()` → `roleInCompany()`
- [ ] `tests/Feature/Models/TaskTest.php` - `addUser()` çağrısı
- [ ] `tests/Feature/Models/ContactTest.php` - `addUser()` çağrısı
- [ ] `tests/Feature/Models/AppointmentTest.php` - `addUser()` çağrısı

---

## Data Migration (Mevcut Veri Varsa)

```php
// Mevcut company_user.role → Spatie'ye taşı
$companyUsers = DB::table('company_user')->get();
$processedCompanies = [];

foreach ($companyUsers as $cu) {
    setPermissionsTeamId($cu->company_id);
    $user = User::find($cu->user_id);

    // Eğer firma için roller yoksa oluştur (her firma için 1 kez)
    if (!in_array($cu->company_id, $processedCompanies)) {
        if (!Role::where('company_id', $cu->company_id)->exists()) {
            $company = Company::find($cu->company_id);
            // CreateCompanyAction::createDefaultRoles($company) çağır
        }
        $processedCompanies[] = $cu->company_id;
    }

    // Rol dönüşümü
    $roleName = match($cu->role) {
        'owner' => 'Sahip',          // Owner → Sahip
        'admin' => 'Yönetici',       // Admin → Yönetici
        'manager' => 'Yönetici',     // Manager → Yönetici (artık yok)
        default => 'Üye',            // Member → Üye
    };

    $user->assignRole($roleName);
}
```

---

## Dosya Listesi

```
config/
└── permission.php                           # GÜNCELLE

database/migrations/
├── xxxx_add_teams_to_permission_tables.php  # YENİ
├── xxxx_update_invitations_role.php         # YENİ
└── xxxx_remove_role_from_company_user.php   # YENİ (data migration sonrası)

app/
├── Enums/
│   └── CompanyRole.php                      # SİL
├── Models/
│   ├── User.php                             # GÜNCELLE
│   ├── Company.php                          # GÜNCELLE
│   └── Invitation.php                       # GÜNCELLE
├── Data/
│   └── InvitationData.php                   # GÜNCELLE
├── Actions/Auth/
│   ├── CreateCompanyAction.php              # GÜNCELLE
│   ├── SendInvitationAction.php             # GÜNCELLE
│   └── AcceptInvitationAction.php           # GÜNCELLE
├── Notifications/
│   └── InviteUserNotification.php           # GÜNCELLE
└── Providers/
    └── AppServiceProvider.php               # GÜNCELLE

database/
├── factories/
│   └── UserFactory.php                      # GÜNCELLE
└── seeders/
    ├── DatabaseSeeder.php                   # GÜNCELLE
    └── RoleSeeder.php                       # GÜNCELLE

resources/views/livewire/team/
└── index.blade.php                          # GÜNCELLE

tests/Feature/Models/
├── CompanyTest.php                          # GÜNCELLE
├── UserTest.php                             # GÜNCELLE
├── TaskTest.php                             # GÜNCELLE
├── ContactTest.php                          # GÜNCELLE
└── AppointmentTest.php                      # GÜNCELLE
```

---

## Doğrulama

```bash
# Migration
php artisan migrate

# Cache temizle
php artisan permission:cache-reset
php artisan config:clear

# Testler
php artisan test --filter=Company
php artisan test --filter=User
php artisan test --filter=Auth
php artisan test --filter=Team
```

### Manuel Test:
1. Yeni kayıt → Firma oluştur → Owner + Yönetici olmalı
2. Team sayfası → Davet gönder → Rol seç
3. Davet kabul → Doğru rol atanmalı
4. Rol değiştir → Spatie tablosunda güncellenmeli
5. Owner her işlemi yapabilmeli

---

## Güvenlik Notları

- [ ] Owner kendini silemez
- [ ] Owner başkası tarafından silinemez
- [ ] Privilege escalation önleme (kendi izinlerinden fazlasını veremez)
- [ ] Rol değişikliği audit log'a yazılabilir (gelecek faz)
