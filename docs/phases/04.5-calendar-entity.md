# Faz 4.5: Calendar Entity

**Süre:** 1-2 gün  
**Önkoşul:** Faz 4 (Calendar UI)  
**Çıktı:** Çoklu takvim desteği için altyapı

---

## Amaç

Şirket içinde birden fazla takvim (varsayılan, ekip, kaynak, kişisel) oluşturabilme altyapısını kurmak. Bu yapı:
- Faz 5'te randevuların doğru takvime yazılmasını sağlar
- Faz 6'da Google Calendar'ın kişisel takvime sync edilmesini mümkün kılar
- İleride ekip takvimleri, toplantı odası takvimleri gibi esneklikleri sunar

---

## Veri Modeli

```
Company (1)
    └── Calendar (N)
            ├── name: "Genel Takvim" / "Satış Ekibi" / "Toplantı Odası A"
            ├── color: "#3b82f6"
            ├── type: 'default' | 'team' | 'resource' | 'personal'
            ├── visibility: 'company_wide' | 'members_only' | 'private'
            ├── is_default: boolean
            └── Appointment (N)

CalendarUser (pivot)
    ├── calendar_id
    ├── user_id
    └── role: 'owner' | 'editor' | 'viewer'
```

---

## Görevler

### 4.5.1 Calendars Migration

- [ ] `php artisan make:migration create_calendars_table`

```php
Schema::create('calendars', function (Blueprint $table) {
    $table->id();
    $table->foreignId('company_id')->constrained()->cascadeOnDelete();
    $table->string('name', 100);
    $table->string('color', 7)->default('#3b82f6');
    $table->string('type', 20)->default('default'); // default, team, resource, personal
    $table->string('visibility', 20)->default('company_wide'); // company_wide, members_only, private
    $table->boolean('is_default')->default(false);
    $table->string('google_calendar_id')->nullable()->unique(); // Faz 6 için hazırlık
    $table->json('settings')->nullable();
    $table->timestamps();

    $table->index(['company_id', 'type']);
});
```

### 4.5.2 CalendarUser Pivot Migration

- [ ] `php artisan make:migration create_calendar_user_table`

```php
Schema::create('calendar_user', function (Blueprint $table) {
    $table->foreignId('calendar_id')->constrained()->cascadeOnDelete();
    $table->foreignId('user_id')->constrained()->cascadeOnDelete();
    $table->string('role', 20)->default('viewer'); // owner, editor, viewer
    $table->timestamps();

    $table->primary(['calendar_id', 'user_id']);
});
```

### 4.5.3 Appointments Table Update

- [ ] `php artisan make:migration add_calendar_id_to_appointments_table`

```php
Schema::table('appointments', function (Blueprint $table) {
    $table->foreignId('calendar_id')->nullable()->after('company_id')->constrained()->nullOnDelete();
});

// Mevcut randevuları default takvime bağla (seeder'da yapılacak)
```

### 4.5.4 Calendar Model

- [ ] `php artisan make:model Calendar`

```php
class Calendar extends Model
{
    use HasFactory;

    protected $fillable = [
        'company_id', 'name', 'color', 'type', 
        'visibility', 'is_default', 'google_calendar_id', 'settings',
    ];

    protected $casts = [
        'is_default' => 'boolean',
        'settings' => 'array',
    ];

    // Relations
    public function company(): BelongsTo
    {
        return $this->belongsTo(Company::class);
    }

    public function appointments(): HasMany
    {
        return $this->hasMany(Appointment::class);
    }

    public function users(): BelongsToMany
    {
        return $this->belongsToMany(User::class)
            ->withPivot('role')
            ->withTimestamps();
    }

    // Scopes
    public function scopeForCompany(Builder $query, int $companyId): Builder
    {
        return $query->where('company_id', $companyId);
    }

    public function scopeAccessibleBy(Builder $query, User $user): Builder
    {
        return $query->where(function ($q) use ($user) {
            // Şirket geneli takvimler
            $q->where('visibility', 'company_wide')
              ->where('company_id', $user->currentCompany()?->id);
        })->orWhere(function ($q) use ($user) {
            // Üye olduğu takvimler
            $q->whereHas('users', fn ($uq) => $uq->where('user_id', $user->id));
        });
    }

    // Helpers
    public function isAccessibleBy(User $user): bool
    {
        if ($this->visibility === 'company_wide' && $this->company_id === $user->currentCompany()?->id) {
            return true;
        }
        return $this->users()->where('user_id', $user->id)->exists();
    }
}
```

### 4.5.5 CalendarType & CalendarVisibility Enums

- [ ] `app/Enums/CalendarType.php`

```php
enum CalendarType: string
{
    case Default = 'default';
    case Team = 'team';
    case Resource = 'resource';
    case Personal = 'personal';

    public function label(): string
    {
        return match ($this) {
            self::Default => __('enums.calendar_type.default'),
            self::Team => __('enums.calendar_type.team'),
            self::Resource => __('enums.calendar_type.resource'),
            self::Personal => __('enums.calendar_type.personal'),
        };
    }
}
```

- [ ] `app/Enums/CalendarVisibility.php`

```php
enum CalendarVisibility: string
{
    case CompanyWide = 'company_wide';
    case MembersOnly = 'members_only';
    case Private = 'private';

    public function label(): string
    {
        return match ($this) {
            self::CompanyWide => __('enums.calendar_visibility.company_wide'),
            self::MembersOnly => __('enums.calendar_visibility.members_only'),
            self::Private => __('enums.calendar_visibility.private'),
        };
    }
}
```

### 4.5.6 Appointment Model Update

- [ ] `app/Models/Appointment.php` güncelle:

```php
// Yeni relation
public function calendar(): BelongsTo
{
    return $this->belongsTo(Calendar::class);
}

// fillable'a ekle
'calendar_id',
```

### 4.5.7 Company Observer - Auto Create Default Calendar

- [ ] `app/Observers/CompanyObserver.php`

```php
class CompanyObserver
{
    public function created(Company $company): void
    {
        $company->calendars()->create([
            'name' => 'Genel Takvim',
            'type' => CalendarType::Default->value,
            'visibility' => CalendarVisibility::CompanyWide->value,
            'is_default' => true,
            'color' => '#3b82f6',
        ]);
    }
}
```

### 4.5.8 CalendarService Update

- [ ] `app/Services/CalendarService.php` güncelle:

```php
// Metod imzalarını güncelle
public function getAppointmentsForWeek(Carbon $date, int $companyId, ?int $calendarId = null): Collection
{
    $query = Appointment::whereHas('calendar', fn ($q) => $q->where('company_id', $companyId));
    
    if ($calendarId) {
        $query->where('calendar_id', $calendarId);
    }
    
    // ... geri kalan kod aynı
}
```

### 4.5.9 Migration Seeder

- [ ] Existing companies için default calendar oluştur:

```php
// database/seeders/CalendarMigrationSeeder.php
class CalendarMigrationSeeder extends Seeder
{
    public function run(): void
    {
        $companies = Company::whereDoesntHave('calendars')->get();
        
        foreach ($companies as $company) {
            $calendar = $company->calendars()->create([
                'name' => 'Genel Takvim',
                'type' => 'default',
                'visibility' => 'company_wide',
                'is_default' => true,
            ]);
            
            // Mevcut randevuları bu takvime bağla
            Appointment::where('company_id', $company->id)
                ->whereNull('calendar_id')
                ->update(['calendar_id' => $calendar->id]);
        }
    }
}
```

---

## Visibility Mantığı

| Visibility | Kimler Görür? | Kimler Düzenler? |
|------------|---------------|------------------|
| `company_wide` | Şirketteki herkes | calendar_user pivot'taki roller |
| `members_only` | Sadece calendar_user'daki kişiler | Sadece editor/owner |
| `private` | Sadece owner | Sadece owner |

---

## Doğrulama

```bash
php artisan migrate
php artisan db:seed --class=CalendarMigrationSeeder
php artisan test --filter=Calendar
```

**Manuel test:**
1. Şirkete giriş yap → Varsayılan "Genel Takvim" var mı?
2. Mevcut randevular bu takvimde görünüyor mu?
3. Takvim sayfası hala çalışıyor mu?

---

## Dosya Listesi

```
database/migrations/
├── xxxx_create_calendars_table.php
├── xxxx_create_calendar_user_table.php
└── xxxx_add_calendar_id_to_appointments_table.php

database/seeders/
└── CalendarMigrationSeeder.php

app/
├── Models/
│   ├── Calendar.php
│   └── Appointment.php (güncellendi)
├── Enums/
│   ├── CalendarType.php
│   └── CalendarVisibility.php
├── Observers/
│   └── CompanyObserver.php
└── Services/
    └── CalendarService.php (güncellendi)
```

---

## Notlar

- Bu faz sadece **altyapı** oluşturur, UI değişikliği minimal
- Takvim seçici UI → Faz 5 veya sonrası
- Google Calendar sync → Faz 6'da `google_calendar_id` kullanılacak
- Çoklu takvim overlay görünümü → Post-MVP
